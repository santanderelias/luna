<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href="vendor/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="app.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">
    <title>Luna</title>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Toast Template -->
    <template id="toast-template">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Luna</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Hello, world! This is a toast message.
            </div>
        </div>
    </template>

    <div class="app-container">
        <!-- Page: Add Transaction -->
        <div id="page-add-transaction" class="page">
            <div class="page-header">
                <h1>Add Transaction</h1>
            </div>
            <div class="page-content">
                <div class="input-group mb-3">
                    <span class="input-group-text">$</span>
                    <input id="amountInputBox" type="number" class="form-control" placeholder="Amount" required>
                </div>
                <div class="input-group mb-3">
                    <input type="date" class="form-control" id="transaction-date" required>
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">Notes</span>
                    <input id="notesInputBox" type="text" class="form-control" placeholder="Transaction notes">
                </div>
                <button id="saveTransaction" class="btn btn-success w-100" onclick="saveTransaction()">Save!</button>
            </div>
        </div>

        <!-- Page: Statistics -->
        <div id="page-statistics" class="page">
            <div class="page-header">
                <h1>Statistics</h1>
            </div>
            <div class="page-content">
                <div class="chart-container">
                    <canvas id="incomeExpenseChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="expenseBreakdownChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="timeToTargetChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Page: Transaction History -->
        <div id="page-history" class="page">
            <div class="page-header">
                <h1>History</h1>
            </div>
            <div class="page-content">
                <table id="transactionHistoryVisibilityTable" class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Fecha</th>
                            <th scope="col">Monto</th>
                            <th scope="col">Notas</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Page: Vars -->
        <div id="page-vars" class="page">
            <div class="page-header">
                <h1>Variables</h1>
            </div>
            <div class="page-content">
                <h3>Current Data</h3>
                <table class="table table-hover">
                    <tbody>
                        <tr><td>Current Balance</td><td id="currentBalance">0</td></tr>
                        <tr><td>Spend to Date This Month</td><td id="spendToDateThisMonth">0</td></tr>
                        <tr><td>Spent Per Day</td><td id="spentPerDay">0</td></tr>
                    </tbody>
                </table>
                <h3>Projections</h3>
                <table class="table table-hover">
                    <tbody>
                        <tr><td>Monthly Spent Projection</td><td id="monthlySpentProjection">0</td></tr>
                        <tr><td>Net Monthly Projection</td><td id="netMonthlyProjection">0</td></tr>
                    </tbody>
                </table>
                <h3>Set Projections</h3>
                <div class="mb-3">
                    <label for="projection-date-picker" class="form-label">Projection Target Date</label>
                    <input type="date" class="form-control" id="projection-date-picker">
                </div>
                <table class="table table-hover">
                    <tbody>
                        <tr><td>Spending to Date X</td><td id="spendingToDateX">0</td></tr>
                        <tr><td>Paychecks to Date X</td><td id="paychecksToDateX">0</td></tr>
                        <tr><td>Projected Income to Date X</td><td id="projectedIncomeToDateX">0</td></tr>
                        <tr><td>Predicted Cash Balance to Date X</td><td id="predictedCashBalanceToDateX">0</td></tr>
                        <tr><td>Time to Reach Target</td><td id="timeToReachTarget">N/A</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Page: Settings -->
        <div id="page-settings" class="page">
            <div class="page-header">
                <h1>Settings</h1>
            </div>
            <div class="page-content">
                <div class="accordion" id="settingsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingGeneral">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeneral" aria-expanded="true" aria-controls="collapseGeneral">
                                General
                            </button>
                        </h2>
                        <div id="collapseGeneral" class="accordion-collapse collapse show" aria-labelledby="headingGeneral" data-bs-parent="#settingsAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label for="current-balance-input" class="form-label">Current Balance</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="current-balance-input" value="0">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="target-cash-input" class="form-label">Target Cash Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="target-cash-input" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingRecurringIncome">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRecurringIncome" aria-expanded="false" aria-controls="collapseRecurringIncome">
                                Recurring Income
                            </button>
                        </h2>
                        <div id="collapseRecurringIncome" class="accordion-collapse collapse" aria-labelledby="headingRecurringIncome" data-bs-parent="#settingsAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label for="paycheck1-input" class="form-label">Paycheck on the 15th</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="paycheck1-input" value="0">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="paycheck2-input" class="form-label">Paycheck on End of Month</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="paycheck2-input" value="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOneTimeIncome">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOneTimeIncome" aria-expanded="false" aria-controls="collapseOneTimeIncome">
                                Add One-Time Income
                            </button>
                        </h2>
                        <div id="collapseOneTimeIncome" class="accordion-collapse collapse" aria-labelledby="headingOneTimeIncome" data-bs-parent="#settingsAccordion">
                            <div class="accordion-body">
                                <div class="input-group">
                                    <input type="number" id="income-amount-input" class="form-control" placeholder="Amount">
                                    <input type="text" id="income-notes-input" class="form-control" placeholder="Notes">
                                    <button class="btn btn-outline-secondary" type="button" onclick="addIncome()">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFixedExpenses">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFixedExpenses" aria-expanded="false" aria-controls="collapseFixedExpenses">
                                Fixed Monthly Expenses
                            </button>
                        </h2>
                        <div id="collapseFixedExpenses" class="accordion-collapse collapse" aria-labelledby="headingFixedExpenses" data-bs-parent="#settingsAccordion">
                            <div class="accordion-body">
                                <div id="fixed-expenses-list" class="mb-3"></div>
                                <div class="input-group">
                                    <input type="text" id="fixed-expense-description-input" class="form-control" placeholder="Expense Description">
                                    <input type="number" id="fixed-expense-amount-input" class="form-control" placeholder="Amount">
                                    <button class="btn btn-outline-secondary" type="button" onclick="addFixedExpense()">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary w-100 mt-3" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navbar -->
    <div class="navbar">
        <a href="#" class="nav-button" data-page="statistics">
            <img src="res/a.png" alt="Stats">
            <span>Stats</span>
        </a>
        <a href="#" class="nav-button" data-page="history">
            <img src="res/b.png" alt="History">
            <span>History</span>
        </a>
        <a href="#" class="nav-button special" data-page="add-transaction">
            <img src="res/c.png" alt="Add">
        </a>
        <a href="#" class="nav-button" data-page="vars">
            <img src="res/d.png" alt="Vars">
            <span>Vars</span>
        </a>
        <a href="#" class="nav-button" data-page="settings">
            <img src="res/e.png" alt="Settings">
            <span>Settings</span>
        </a>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-transaction-index">
            <div class="mb-3">
              <label for="edit-transaction-date" class="form-label">Date</label>
              <input type="date" class="form-control" id="edit-transaction-date">
            </div>
            <div class="mb-3">
              <label for="edit-transaction-type" class="form-label">Type</label>
              <div class="btn-group" role="group" aria-label="Edit Transaction type">
                <input type="radio" class="btn-check" name="editTransactionType" id="edit-gasto" value="gasto" autocomplete="off">
                <label class="btn btn-outline-primary" for="edit-gasto">Gasto</label>

                <input type="radio" class="btn-check" name="editTransactionType" id="edit-ingreso" value="ingreso" autocomplete="off">
                <label class="btn btn-outline-primary" for="edit-ingreso">Ingreso</label>
              </div>
            </div>
            <div class="mb-3">
              <label for="edit-transaction-amount" class="form-label">Amount</label>
              <input type="number" class="form-control" id="edit-transaction-amount">
            </div>
            <div class="mb-3">
              <label for="edit-transaction-notes" class="form-label">Notes</label>
              <input type="text" class="form-control" id="edit-transaction-notes">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="saveEditedTransaction()">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="confirmationModalBody">
            Are you sure you want to perform this action?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <script src="vendor/bootstrap.bundle.min.js"></script>
    <script src="vendor/chart.js"></script>
    <script src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            let newWorker;

            navigator.serviceWorker.register('/luna/sw.js').then(reg => {
                // Show a toast if an update is found
                reg.addEventListener('updatefound', () => {
                    newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            const toastMessage = `
                                New version available!
                                <button class="btn btn-light btn-sm float-end ms-2" onclick="newWorker.postMessage({ action: 'skipWaiting' })">
                                    Reload
                                </button>
                            `;
                            showToast(toastMessage, 'info', { autohide: false });
                        }
                    });
                });

                // Show a toast when the app is ready for offline use for the first time
                if (!localStorage.getItem('pwa_installed')) {
                    reg.ready.then(() => {
                         if (navigator.serviceWorker.controller) {
                            showToast('App is ready for offline use.', 'success');
                            localStorage.setItem('pwa_installed', 'true');
                        }
                    });
                }
            });

            // Reload the page after the new service worker has taken control
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                showToast('App has been updated!', 'success');
                window.location.reload();
                refreshing = true;
            });
        }
    </script>
</body>
</html>
